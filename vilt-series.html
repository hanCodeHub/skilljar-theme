<!-- Code inserted in the Header of VILT Course Series -->
<section id="vilt-section">

    <!-- header for title and filter controls -->
    <div id="vilt-header" hidden>
        <h1 class="section-header text-center">Select A Virtual Class</h1>
        <div id="filters-row">
            <select name="capability" id="filter-select" class="filter-control">
                <!-- values should match tag names of capabilities -->
                <option selected value="all">All Capabilities</option>
                <option value="workflow">Workflow</option>
                <option value="forms">Forms</option>
                <option value="process mapping">Process Mapping</option>
                <option value="docgen">DocGen</option>
                <option value="rpa">RPA</option>
            </select>

            <input type="text" id="filter-search" class="filter-control" placeholder="Search class names">
            <span class="fa fa-search"></span>
        </div>

    </div>

    <!-- loader animation removed when cards render -->
    <div id="events-loader">
        <h3 class="text-center">Fetching available classes...</h3>
        <div class="loader-dark"></div>
    </div>

    <!-- container for all VILT event cards -->
    <div id="vilt-events" hidden>
        <!-- template for a VILT event card - render real cards with JS -->
        <div class="card-wide card-container" hidden>
            <div class="img-container">
                <img class="event-img"
                    src="https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fnintexu-vILT.1576697456192.jpg"
                    alt="event image">
            </div>
            <!-- event card -->
            <div class="card-wide-content">
                <h4 class="card-wide-title">
                    Some main title for the course
                </h4>
                <p class="card-wide-subtitle">
                    Some kind of subtitle explaining the goal of this course
                </p>
                <div class="event-times-container">
                    <h5>Available times:</h5>
                    <div class="event-times">
                        <div class="pill-outline" hidden>
                            <p class="pill-text pill-date">Nov 26, 2019</p>
                            <p class="pill-text pill-time">09:00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</section>

<!-- STYLES -->
<style>
    #main-container #skilljar-content {
        margin-left: 0;
        background: linear-gradient(to right, #7798a8, #fff);
    }

    #main-container #skilljar-content .top-row {
        padding: 0;
    }

    #main-container #skilljar-content #vilt-events {
        width: 80%;
        margin: auto;
    }

    #main-container #vilt-section h1.section-header {
        font-weight: 350;
        margin: 1.5em 0 1em 0;
    }

    #vilt-header #filters-row {
        display: flex;
        flex-flow: row wrap;
        justify-content: center;
    }

    #vilt-header #filters-row .filter-control {
        width: 12em;
        font-size: inherit;
        color: inherit;
        border-radius: 5px;
        padding: 4px;
        border: 2px solid #052332;
        margin: 0 2em .5em 2em;
    }

    #vilt-header #filters-row select.filter-control {
        cursor: pointer;
    }

    #vilt-header #filters-row input.filter-control {
        text-indent: 4px;
    }

    #vilt-section #events-loader {
        margin-top: 3em;
    }

    #vilt-section #vilt-events .card-wide {
        border: 4px solid #052332;
        background-color: #fff;
        display: flex;
        margin: 2em auto;
        max-width: 60em;
        cursor: pointer;
        transition: all .3s ease;
    }

    #vilt-section #vilt-events .card-wide:hover {
        background-color: #052332;
    }

    #vilt-section #vilt-events .card-wide:hover h4,
    #vilt-section #vilt-events .card-wide:hover h5,
    #vilt-section #vilt-events .card-wide:hover .card-wide-subtitle {
        color: #fff;
    }

    #vilt-section #vilt-events .img-container {
        overflow: hidden;
        max-width: 28%;
        display: flex;
        align-items: center;
    }

    #vilt-section #vilt-events .card-wide img {
        width: 100%;
        transform: scale(1.5);
    }

    @media only screen and (max-width: 1150px) {
        #vilt-section #vilt-events .img-container {
            display: none;
        }

        #vilt-section #vilt-events .card-wide {
            text-align: center;
        }
    }

    #vilt-section #vilt-events .card-wide .card-wide-content {
        width: 100%;
        margin: 0 1em;
        display: flex;
        flex-flow: column;
        justify-content: space-between;
    }

    .card-wide-content .card-wide-title {
        margin-bottom: 0;
        font-size: 1.3em;
    }

    .card-wide-content .card-wide-subtitle {
        color: #666464;
        font-size: 1.1em;
        margin-bottom: 0;
    }

    #vilt-events .event-times-container {
        display: flex;
        flex-flow: column wrap;
        margin-bottom: .5em;
        margin-top: .5em;
    }

    #vilt-events .event-times-container .event-times .pill-outline {
        display: inline-block;
        background-color: white;
        border: 3px solid #ff6d00;
        border-radius: 10px;
        padding: 0 4px;
        margin: 0 0 .5em 1.5em;
    }

    #vilt-events .event-times-container .event-times .pill-outline .pill-text {
        font-size: .8em;
        margin-bottom: 0;
        text-align: center;
    }
</style>


<!-- MINOR DOM EDITS -->
<script>
    // remove all search elements and reset searchbar
    document.querySelector('.search-container').remove();
</script>


<!-- API CALLS -->
<script>

    // MAIN
    if (location.pathname == "/series/vilt") {

        const baseUrl = "https://skilljar-api-test.azurewebsites.net";
        const domain = "learn.nintex.com";  // change domain to location.host
        const user = getUser();  // user skilljar object

        // render live events into view
        callEventsData(baseUrl, domain)
            .then(events => renderVilt(events))
            .catch((err) => console.log(err));

        // add user progress to view if user is logged in
        // if (user) {
        //     callUserData(baseUrl, domain, user.id)
        //         .then(records => records)
        //         .catch(err => console.log(err));
        // }

    }

    // returns the user Skilljar object if logged in, or null otherwise
    function getUser() {
        let user = null;
        try {
            user = skilljarUser;
        } catch (error) {
            console.log("user needs to sign in to see skilljar data.")
        }
        return user;
    }

    // generic fetch function
    async function getData(url) {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        return await response.json();
    }

    // fetch user data with id from Skilljar API
    async function callUserData(baseUrl, domain, userId) {
        try {
            return await getData(`${baseUrl}/users/${userId}/${domain}`)
                .then(res => res.data)
                .catch(err => console.log(err));
        } catch (error) {
            console.log(`Error getting data from api: ${error}`);
        }
    }

    // fetch events data by unique course
    async function callEventsData(baseUrl, domain) {
        try {
            return await getData(`${baseUrl}/events/${domain}?unique_view=True`)
                .then(res => res.data)
                .catch(err => console.log(err));
        } catch (error) {
            console.log(`Error getting data from api: ${error}`);
        }
    }


    // DYNAMIC RENDERING OF EVENTS

    // renders all VILT event cards with data from API
    function renderVilt(events) {
        // remove loader animation
        document.getElementById('events-loader').remove();
        // attach template to #skilljar-content section
        const vilt = document.getElementById("vilt-section");
        const content = document.getElementById("skilljar-content");
        content.appendChild(vilt);

        // template elements
        const viltCard = document.querySelector('.card-wide');
        const viltEvents = document.getElementById('vilt-events');

        // for each event copy viltCard template and fill with ev data
        events.forEach(ev => renderEvent(ev, viltCard, viltEvents));

        // unhide real elements and hide template card
        viltEvents.hidden = false;
        document.getElementById("vilt-header").hidden = false;
        // removes class with display:flex which enables hidden on template
        viltCard.remove();
    }

    // renders a single event card to the vilt-events section
    function renderEvent(ev, viltCard, viltEvents) {
        // copy template card and get its child elements
        const card = viltCard.cloneNode(true);
        const title = card.querySelector(".card-wide-title");
        const subtitle = card.querySelector(".card-wide-subtitle");
        const image = card.querySelector(".event-img");

        // populate text with API data
        title.innerText = ev.vilt_session.lesson.course.title;
        subtitle.innerText = ev.short_description;
        image.src = getImageUrl(ev.tags[0]);
        renderEventTime(ev, card);
        card.dataset.tag = ev.tags[0];  // set data attrib to capability

        // add link to card and append card to vilt-events
        const url = ev.vilt_session.lesson.course.course_url;
        card.addEventListener('click', () => window.open(url));
        viltEvents.appendChild(card);
    }

    // returns the image URL based on product capability
    function getImageUrl(productCap) {
        // images stored in Skilljar Image Respository course series
        imageUrls = {
            forms: "https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fcourse_forms.1576814645570.png",
            workflow: "https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fcourse-workflow.1576814629068.png"
        }

        // NEED TO ADD MORE IMAGE URLS
        // - process mapping
        // - docgen
        // - rpa

        // match image URL with product capability
        productCap = productCap.toLowerCase();
        if (productCap == "workflow") return imageUrls.workflow;
        else if (productCap == "forms") return imageUrls.forms;
    }

    // renders an event datetime pill within a given card
    function renderEventTime(event, card) {
        // render each event start time + date in local time
        const viltPill = card.querySelector(".pill-outline");
        event.starts_at.forEach(eventTime => {
            if (eventTime.seats <= 0) return; // skip if no available seats

            const dateTime = new Date(eventTime.time);
            // format as Nov 26, 2019
            let localDate = dateTime.toDateString().slice(4);
            localDate = localDate.substring(0, 6) + ', ' + localDate.substring(7);
            // format time as 13:00
            let localTime = dateTime.toTimeString().slice(0, 5);

            // datetime pill is cloned and populated for each start time

            const dtPill = viltPill.cloneNode(true);
            dtPill.querySelector(".pill-date").innerText = localDate;
            dtPill.querySelector(".pill-time").innerText = localTime;

            // pill added to times section
            card.querySelector(".event-times").append(dtPill);
        });
        viltPill.style.display = "none";
    }

</script>


<!-- FILTER AND SEARCH -->
<script>
    // viltCards stores all available cards
    const viltCards = document.querySelectorAll('.card-wide');
    const filterSelect = document.getElementById('filter-select');
    const filterSearch = document.getElementById('filter-search');
    

    filterSelect.addEventListener('change', handleFilterSelect);
    filterSearch.addEventListener('change', handleFilterSearch);

    // filters out all vilt cards that don't match selection
    function handleFilterSelect(e) {
        const viltCards = document.querySelectorAll('.card-wide');
        const selected = e.target.value.toLowerCase();
        
        // capability stored on data-tag of each card
        for (card of viltCards) {
            card.style.display = "flex";  // reset before filtering
            const tag = card.dataset.tag.toLowerCase();
            
            if (tag != selected && selected != "all")
                card.style.display = "none";
        }
    }

    function handleFilterSearch(e) { 
        const viltCards = document.querySelectorAll('.card-wide');
        const input = e.target.value.toLowerCase();

        for (card of viltCards) {
            card.style.display = "flex";  // reset before filtering
            const name = card.lastElementChild.firstElementChild.innerText;
            
            if (!name.toLowerCase().includes(input))
                card.style.display = "none";
        }
    }
</script>
