<!-- Code inserted in the Header of VILT Course Series -->
<section id="vilt-section">

    <!-- header for title and filter controls -->
    <div id="vilt-header" hidden>
        <h1 class="section-header text-center">Select A Virtual Class</h1>
        <div id="filters-row">
            <select name="capability" id="filter-select" class="filter-control">
                <!-- values should match tag names of capabilities -->
                <option selected value="all">All Capabilities</option>
                <option value="workflow">Workflow</option>
                <option value="forms">Forms</option>
                <option value="process mapping">Process Mapping</option>
                <option value="docgen">DocGen</option>
                <option value="rpa">RPA</option>
            </select>

            <input type="text"  id="filter-search" class="filter-control"
                placeholder="Search class names"
            >
            <span class="fa fa-search"></span>
        </div>

    </div>

    <!-- loader animation removed when cards render -->
    <div id="events-loader">
        <h3 class="text-center">Fetching available classes...</h3>
        <div class="loader-dark"></div>
    </div>

    <!-- container for all VILT event cards -->
    <div id="vilt-events" hidden>
        <!-- template for a VILT event card - render real cards with JS -->
        <div id="vilt-card" class="card-wide card-container" hidden>
            <img id="event-img"
                src="https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fnintexu-vILT.1576697456192.jpg"
                alt="event image">

            <div class="card-wide-content">
                <h4 id="event-title" class="card-wide-title">
                    Some main title for the course
                </h4>
                <p id="event-subtitle" class="card-wide-subtitle">
                    Some kind of subtitle explaining the goal of this course
                </p>
                <div id="event-times-container">
                    <h5>Available times:</h5>
                    <div id="event-times">
                        <div id="dt-pill" class="pill-outline" hidden>
                            <p id="event-date" class="pill-text">Nov 26, 2019</p>
                            <p id="event-time" class="pill-text">09:00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</section>

<!-- STYLES -->
<style>
    #main-container #skilljar-content {
        margin-left: 0;
        background: linear-gradient(to right, #7798a8, #fff);
    }

    #main-container #skilljar-content .top-row {
        padding: 0;
    }

    #main-container #skilljar-content #vilt-events {
        width: 80%;
        margin: auto;
    }

    #main-container #vilt-section h1.section-header {
        font-weight: 350;
        margin: 1em 0;
    }

    #vilt-header #filters-row {
        display: flex;
        flex-flow: row wrap;
        justify-content: center;
    }

    #vilt-header #filters-row .filter-control {
        width: 12em;
        font-size: inherit;
        color: inherit;
        border-radius: 5px;
        padding: 4px;
        border: 2px solid #052332;
        margin: 0 2em .5em 2em;
    }
    #vilt-header #filters-row select.filter-control { 
        cursor: pointer;
    }
    #vilt-header #filters-row input.filter-control { 
        text-indent: 4px;
    }

    #vilt-section #events-loader {
        margin-top: 3em;
    }

    #vilt-section #vilt-events #vilt-card.card-wide {
        border: 4px solid #052332;
        background-color: #fff;
        display: flex;
        margin: 2em auto;
        max-width: 60em;
        cursor: pointer;
        transition: all .3s ease;
    }

    #vilt-section #vilt-events #vilt-card.card-wide:hover {
        background-color: #052332;
    }

    #vilt-section #vilt-events #vilt-card.card-wide:hover h4,
    #vilt-section #vilt-events #vilt-card.card-wide:hover h5,
    #vilt-section #vilt-events #vilt-card.card-wide:hover #event-subtitle {
        color: #fff;
    }

    #vilt-section #vilt-events .card-wide img {
        max-width: 15em;
        margin-left: -1px;
    }

    @media only screen and (max-width: 1023px) {
        #vilt-section #vilt-events .card-wide img {
            display: none;
        }
    }

    #vilt-section #vilt-events .card-wide .card-wide-content {
        width: 100%;
        margin: 0 1em;
    }

    .card-wide-content .card-wide-title {
        margin-bottom: 0;
        font-size: 1.3em;
    }

    .card-wide-content .card-wide-subtitle {
        color: #666464;
        font-size: 1.1em;
        margin-bottom: .5em;
    }

    #vilt-events #event-times-container {
        display: flex;
        flex-flow: row wrap;
        margin-bottom: .5em;
    }

    #vilt-events #event-times-container #event-times .pill-outline {
        display: inline-block;
        background-color: white;
        border: 3px solid #ff6d00;
        border-radius: 10px;
        padding: 0 4px;
        margin: 0 0 .5em 1.5em;
    }

    #vilt-events #event-times-container #event-times .pill-outline .pill-text {
        font-size: .8em;
        margin-bottom: 0;
        text-align: center;
    }
</style>


<!-- MINOR DOM EDITS -->
<script>
    // remove all search elements and reset searchbar
    document.querySelector('.search-container').remove();
</script>


<!-- API CALLS -->
<script>

    if (location.pathname == "/series/vilt") {
        const baseUrl = "https://skilljar-api-test.azurewebsites.net";
        const domain = "learn.nintex.com";  // change domain to location.host

        // get user records after rendering view
        callEventsData(baseUrl, domain)
            .then(events => renderVilt(events))
            .then(() => getUserRecords(baseUrl, domain))
            .catch((err) => console.log(err));

    }

    // generic fetch function
    async function getData(url) {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        return await response.json();
    }

    // fetch user data with id from Skilljar API
    async function callUserData(baseUrl, domain, userId) {
        try {
            return await getData(`${baseUrl}/users/${userId}/${domain}`)
                .then(res => res.data)
                .then(userRecords => console.log(userRecords))
                .catch(err => console.log(err));
        } catch (error) {
            console.log(`Error getting data from api: ${error}`);
        }
    }

    // fetch events data by unique course
    async function callEventsData(baseUrl, domain) {
        try {
            return await getData(`${baseUrl}/events/${domain}?unique_view=True`)
                .then(res => res.data)
                .catch(err => console.log(err));
        } catch (error) {
            console.log(`Error getting data from api: ${error}`);
        }
    }

    // obtains user id first before calling API
    function getUserRecords(baseUrl, domain) {
        // Poll the script tag for the user id until found
        const pollUserId = setInterval(getUserId, 100);

        // inner function checks if id string exists
        function getUserId() {
            const scriptText = document.scripts[10].innerText;
            const userData = scriptText.match("(?<=id\: \').*(?=')");

            // if found, clear interval and make fetch call
            if (userData) {
                const userId = userData[0];
                clearInterval(pollUserId);
                callUserData(baseUrl, domain, userId);
            }
        }
    }


    // DYNAMIC RENDERING OF EVENTS

    // attach content to #skilljar-content section
    const vilt = document.getElementById("vilt-section");
    const content = document.getElementById("skilljar-content");
    content.appendChild(vilt);

    // renders a VILT event card with data from API
    function renderVilt(events) {
        // remove loader animation
        document.getElementById('events-loader').remove();

        // template elements
        const viltEvents = document.getElementById('vilt-events');
        const viltCard = document.getElementById('vilt-card');

        // for each event copy viltCard template and fill with data
        for (ev of events) {
            // copy template card and get its child elements
            const card = viltCard.cloneNode(true);
            const title = card.querySelector("#event-title");
            const subtitle = card.querySelector("#event-subtitle");
            const image = card.querySelector("#event-img");

            // populate text with API data
            title.innerText = ev.vilt_session.lesson.course.title;
            subtitle.innerText = ev.short_description;
            image.src = getImageUrl(ev.tags[0]);
            renderEventTime(ev, card);

            // add link to card and append card to vilt-events
            url = ev.vilt_session.lesson.course.course_url;
            card.addEventListener('click', () => window.open(url));
            viltEvents.appendChild(card);
        }
        // unhide real elements and hide template card
        viltEvents.hidden = false;
        document.getElementById("vilt-header").hidden = false;
        // removes class with display:flex which enables hidden
        viltCard.classList.remove("card-wide");
    }

    // returns the image URL based on product capability
    function getImageUrl(productCap) {
        // images stored in Skilljar Image Respository course series
        const formsUrl = "https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fcourse_forms.1576814645570.png";
        const workflowUrl = "https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fcourse-workflow.1576814629068.png";

        // find the URL match for product capability
        productCap = productCap.toLowerCase();
        let imageUrl = "";

        if (productCap == "workflow")
            imageUrl = workflowUrl;
        else if (productCap == "forms")
            imageUrl = formsUrl;

        return imageUrl;
    }

    // renders an event datetime pill within a given card
    function renderEventTime(event, card) {
        // render each event start time + date in local time
        const viltPill = card.querySelector("#dt-pill");
        event.starts_at.forEach(eventTime => {
            if (eventTime.seats <= 0) return; // skip if no available seats

            const dateTime = new Date(eventTime.time);
            // format as Nov 26, 2019
            let localDate = dateTime.toDateString().slice(4);
            localDate = localDate.substring(0, 6) + ', ' + localDate.substring(7);
            // format time as 13:00
            let localTime = dateTime.toTimeString().slice(0, 5);

            // datetime pill is cloned and populated for each start time

            const dtPill = viltPill.cloneNode(true);
            dtPill.querySelector("#event-date").innerText = localDate;
            dtPill.querySelector("#event-time").innerText = localTime;

            // pill added to times section
            card.querySelector("#event-times").append(dtPill);
        });
        viltPill.style.display = "none";
    }

</script>


<!-- FILTER AND SEARCH -->
<script>
    const filterSelect = document.getElementById('filter-select');
    const filterSearch = document.getElementById('filter-search');

    filterSelect.addEventListener('change', handleFilterSelect);

    function handleFilterSelect(e) {
        console.log(e.target.value);
    }
</script>