<!-- Code inserted in the Header of VILT Course Series -->
<section id="vilt-section">

    <!-- header for title and filter controls -->
    <div id="vilt-header">

        <div class="header-block-wrapper">
            <div id="header-block">

                <div class="header-block-text">
                    <h1 class="section-header text-center">Join A Virtual Class</h1>
                    <p>
                        All virtual classes are led by our in-house Nintex instructors with deep product knowledge and
                        experience. Select a class below based on available times and the product you want to learn
                        about.
                        After registering for the class, you may then select the session time that works best for you.
                    </p>
                    <span class="text-center btn-outline">
                        <a href="http://learn.nintex.com/calendar" target="_blank">
                            view calendar
                        </a>
                    </span>
                </div>
                <!-- background image on banner -->
                <div class="header-block-graphic"></div>

            </div>
        </div>

    </div>

    <!-- loader animation removed when cards render -->
    <div id="events-loader">
        <h3 class="text-center">Fetching available classes...</h3>
        <div class="loader-dark"></div>
    </div>

    <!-- filter controls -->
    <div id="filters-row" hidden>
        <!-- select filter -->
        <select name="capability" id="filter-select" class="filter-control">
            <!-- values should match tag names of capabilities -->
            <option selected value="all">All Products</option>
            <option value="workflow">Workflow</option>
            <option value="forms">Forms</option>
            <option value="process mapping">Process Mapping</option>
            <option value="docgen">DocGen</option>
            <option value="rpa">RPA</option>
            <option value="sign">Nintex Sign</option>
        </select>

        <!-- search filter -->
        <input type="text" id="filter-search" class="filter-control" placeholder="Search class names">

        <!-- filters reset -->
        <a href="#" id="filter-reset" class="link">
            <img src="https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Freset-icon.1577213905129.png"
                alt="filter reset button">
        </a>
    </div>

    <!-- container for all VILT event cards -->
    <div id="vilt-events" hidden>
        <!-- template for a VILT event card - real cards rendered with JS -->
        <div class="card-wide card-container" hidden>
            <div class="img-container">
                <img class="event-img"
                    src="https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fnintexu-vILT.1576697456192.jpg"
                    alt="event image">
            </div>
            <!-- event card -->
            <div class="card-wide-content">
                <h4 class="card-wide-title">
                    Some main title for the course
                </h4>
                <p class="card-wide-subtitle">
                    Some kind of subtitle explaining the goal of this course
                </p>
                <div class="event-times-container">
                    <h6>
                        Available times:
                        <span class="badge badge-register" hidden>Registered</span>
                        <span class="badge badge-success" hidden>Completed</span>
                    </h6>
                    <div class="event-times">
                        <div class="pill-outline" hidden>
                            <p class="pill-text pill-date">Nov 26, 2019</p>
                            <p class="pill-text pill-time">09:00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</section>

<!-- STYLES -->
<style>
    /* page reset */
    #main-container #skilljar-content {
        margin-left: 0;
        background: linear-gradient(to right, #7798a8, #fff);
    }

    #main-container #skilljar-content .top-row {
        padding: 0;
    }

    /* header title and paragraph */
    #main-container #vilt-section h1.section-header {
        font-weight: 400;
        margin: 1.5em 0 1em 0;
        color: #ff6d00;
    }

    #main-container #vilt-section .header-block-wrapper {
        background: linear-gradient(80deg, black, #052332);
    }

    #main-container #vilt-section #header-block {
        color: #052332;
        margin: auto;
        margin-bottom: 3em;
        display: flex;
        flex-flow: row nowrap;
        max-width: 80%;
        width: 80em;
    }

    #main-container #vilt-section #header-block p {
        font-size: 1.1em;
        font-weight: 300;
        margin-bottom: 2.5em;
    }

    #vilt-section #header-block .header-block-text {
        display: flex;
        flex-flow: column nowrap;
        margin: 2.5em 4em 4em 0;
        color: white;
        letter-spacing: .03em;
    }

    #header-block .header-block-text .btn-outline {
        margin: auto;
    }

    #header-block .header-block-text .btn-outline:hover {
        background-color: #ff6d00;
    }

    .header-block-text .btn-outline a { 
        color: #fff;
    }

    #vilt-section #header-block .header-block-graphic {
        width: 100em;
        background: url("https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fvilt-banner-image.1578434773237.jpg");
        background-size: cover;
    }

    @media only screen and (max-width: 1150px) { 
        #vilt-section #header-block .header-block-graphic { 
            display: none;
        }

        #vilt-section #header-block .header-block-text {
            margin: 2.5em 0;
        }
    }


    /* filter controls */
    #filters-row {
        display: flex;
        flex-flow: row wrap;
        justify-content: center;
    }

    @media only screen and (max-width: 818px) {
        #filters-row {
            flex-flow: column nowrap;
            align-items: center;
        }
    
        #filters-row .filter-control { 
            margin-bottom: 1em;
        }
    }

    #filters-row .filter-control {
        width: 15em;
        font-size: inherit;
        color: inherit;
        border-radius: 5px;
        padding: 4px;
        border: 2px solid #052332;
        margin: 0 2em .5em 2em;
    }

    #filters-row select.filter-control {
        cursor: pointer;
    }

    #filters-row input.filter-control {
        text-indent: 4px;
    }

    #filters-row .link {
        margin-left: 1.5em;
        margin-bottom: 8px;
    }

    /* EVENTS SECTION */
    #main-container #skilljar-content #vilt-events {
        width: 80%;
        margin: auto;
    }

    #vilt-section #events-loader {
        margin-top: 3em;
    }

    /* event cards */
    #vilt-section #vilt-events .card-wide {
        border: 0;
        background-color: #fff;
        display: flex;
        margin: 2em auto;
        max-width: 60em;
        cursor: pointer;
        transition: all .3s ease;
        box-shadow: 2px 4px 8px 0px rgba(46, 61, 73, 0.5);
        border-radius: 3px;
    }

    #vilt-section #vilt-events .card-wide:hover {
        background-color: #052332;
    }

    #vilt-section #vilt-events .card-wide:hover h4,
    #vilt-section #vilt-events .card-wide:hover h6,
    #vilt-section #vilt-events .card-wide:hover .card-wide-subtitle {
        color: #fff;
    }

    /* card image */
    #vilt-section #vilt-events .img-container {
        overflow: hidden;
        max-width: 28%;
        display: flex;
        align-items: center;
    }

    #vilt-section #vilt-events .card-wide img {
        width: 100%;
        transform: scale(1.5);
    }

    @media only screen and (max-width: 1150px) {
        #vilt-section #vilt-events .img-container {
            display: none;
        }

        #vilt-section #vilt-events .card-wide {
            text-align: center;
        }
    }

    /* content inside each card */
    #vilt-section #vilt-events .card-wide .card-wide-content {
        width: 100%;
        margin: 0 1em;
        display: flex;
        flex-flow: column;
        justify-content: space-between;
    }

    .card-wide-content .card-wide-title {
        margin-bottom: 0;
        margin-top: .4em;
        font-size: 1.2em;
    }

    .card-wide-content .card-wide-subtitle {
        color: #666464;
        font-size: 1em;
        margin-bottom: 0;
    }

    #vilt-events .event-times-container {
        display: flex;
        flex-flow: column wrap;
        margin-bottom: .5em;
        margin-top: .5em;
    }

    #vilt-events .event-times-container .badge {
        padding: 4px;
        border-radius: 5px;
        font-size: .8em;
        float: right;
        margin: 0 .5em;
    }

    .badge-register {
        background-color: #ff6d00;
        color: white;
    }

    .badge-success {
        background-color: #4c994c;
        color: #fff;
    }


    #vilt-events .event-times-container .event-times .pill-outline {
        display: inline-block;
        background-color: white;
        border: 2px solid #ff6d00;
        border-radius: 10px;
        padding: 0 4px;
        margin: 0 0 .5em 1.5em;
        font-size: 0.79em;
        letter-spacing: .05em;
    }

    #vilt-events .event-times-container .event-times .pill-outline .pill-text {
        margin-bottom: 0;
        text-align: center;
    }
</style>


<!-- MINOR DOM EDITS/RESETS -->
<script>
    // remove all search elements and reset searchbar
    document.querySelector('.search-container').remove();
    document.getElementById('filters-row').style.display = "none";
</script>


<!-- DOM RENDERING -->
<script>

    // MAIN RENDERING PROGRAM
    if (location.pathname == "/series/vilt") {

        const baseUrl = "https://skilljar-api-test.azurewebsites.net";
        const domain = "learn.nintex.com";  // change domain to location.host
        const user = getUser();  // user skilljar object

        // render live events into view
        callEventsData(baseUrl, domain)
            .then(events => renderVilt(events))
            .catch((err) => console.log(err));

        // add user progress to view if user is logged in
        if (user) {
            callUserData(baseUrl, domain, user.id)
                .then(records => showUserProgress(records))
                .catch(err => console.log(err));
        }

    }
    // END MAIN


    // API CALLS

    // returns the user Skilljar object if logged in, or null otherwise
    function getUser() {
        let user = null;
        try {
            user = skilljarUser;
        } catch (error) {
            console.log("user needs to sign in to see skilljar data.")
        }
        return user;
    }

    // generic fetch function
    async function getData(url) {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        return await response.json();
    }

    // fetch user data with id from Skilljar API
    async function callUserData(baseUrl, domain, userId) {
        try {
            return await getData(`${baseUrl}/users/${userId}/${domain}`)
                .then(res => res.data)
                .catch(err => console.log(err));
        } catch (error) {
            console.log(`Error getting data from api: ${error}`);
        }
    }

    // fetch events data by unique course
    async function callEventsData(baseUrl, domain) {
        try {
            return await getData(`${baseUrl}/events/${domain}?unique_view=True`)
                .then(res => res.data)
                .catch(err => console.log(err));
        } catch (error) {
            console.log(`Error getting data from api: ${error}`);
        }
    }


    // DYNAMIC RENDERING OF EVENTS

    // renders all VILT event cards with data from API
    function renderVilt(events) {
        // remove loader animation
        document.getElementById('events-loader').remove();
        // attach template to #skilljar-content section
        const vilt = document.getElementById("vilt-section");
        const content = document.getElementById("skilljar-content");
        content.appendChild(vilt);

        // template elements
        const viltCard = document.querySelector('.card-wide');
        const viltEvents = document.getElementById('vilt-events');

        // for each event copy viltCard template and fill with ev data
        events.forEach(ev => renderEvent(ev, viltCard, viltEvents));

        // unhide real elements and hide template card
        viltEvents.hidden = false;
        document.getElementById("filters-row").style.display = "flex";
        // removes class with display:flex which enables hidden on template
        viltCard.remove();
    }

    // renders a single event card to the vilt-events section
    function renderEvent(ev, viltCard, viltEvents) {
        // copy template card and get its child elements
        const card = viltCard.cloneNode(true);
        const title = card.querySelector(".card-wide-title");
        const subtitle = card.querySelector(".card-wide-subtitle");
        const image = card.querySelector(".event-img");

        // populate text with API data
        title.innerText = ev.vilt_session.lesson.course.title;
        subtitle.innerText = ev.short_description;
        image.src = getImageUrl(ev.tags[0]);
        renderEventTime(ev, card);

        // set data attributes
        card.dataset.tag = ev.tags[0];  // capability
        card.dataset.id = ev.vilt_session.lesson.course.id  // course id

        // add link to card and append card to vilt-events
        const url = ev.vilt_session.lesson.course.course_url;
        card.addEventListener('click', () => window.open(url));
        viltEvents.appendChild(card);
    }

    // returns the image URL based on product capability
    function getImageUrl(productCap) {

        // images stored in Skilljar Image Respository course series
        imageUrls = {
            forms: "https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fcourse_forms.1576814645570.png",
            workflow: "https://everpath-course-content.s3-accelerate.amazonaws.com/instructor%2Fhan_xu_nintex_com_9jmvc3%2Fpublic%2Fcourse-workflow.1576814629068.png"

            // NEED TO ADD MORE IMAGE URLS
            // - process mapping
            // - docgen
            // - rpa
            // - Nintex Sign
        }

        // match image URL with product capability
        productCap = productCap.toLowerCase();
        if (productCap == "workflow") return imageUrls.workflow;
        else if (productCap == "forms") return imageUrls.forms;
    }

    // renders an event datetime pill within a given card
    function renderEventTime(event, card) {
        // render each event start time + date in local time
        const viltPill = card.querySelector(".pill-outline");
        event.starts_at.forEach(eventTime => {
            if (eventTime.seats <= 0) return; // skip if no available seats

            const dateTime = new Date(eventTime.time);
            // format as Nov 26, 2019
            let localDate = dateTime.toDateString().slice(4);
            localDate = localDate.substring(0, 6) + ', ' + localDate.substring(7);
            // format time as 13:00
            let localTime = dateTime.toTimeString().slice(0, 5);

            // datetime pill is cloned and populated for each start time

            const dtPill = viltPill.cloneNode(true);
            dtPill.querySelector(".pill-date").innerText = localDate;
            dtPill.querySelector(".pill-time").innerText = localTime;

            // pill added to times section
            card.querySelector(".event-times").append(dtPill);
        });
        viltPill.style.display = "none";
    }

    // unhides a registered/completed progress pill on applicable event cards
    function showUserProgress(records) {

        // get all rendered VILT cards
        const viltCards = document.getElementById('vilt-events').children;

        // iterate through all user records to show progress if needed
        for (record of records) {
            for (card of viltCards) {
                showProgress(card, record);
            }
        }
    }

    // unhides a single progress pill based on matching course id
    function showProgress(card, record) {
        // get pills
        const registerBadge = card.querySelector('.badge-register');
        const successBadge = card.querySelector('.badge-success');

        // check record course id against rendered card course id
        if (card.dataset.id == record.course.id) {
            if (record.course_progress.completed_at)
                successBadge.hidden = false;  // completed
            else
                registerBadge.hidden = false;  // registered
        }
    }

</script>


<!-- FILTER AND SEARCH -->
<script>
    // event listeners for filter controls
    const filterSelect = document.getElementById('filter-select');
    const filterSearch = document.getElementById('filter-search');
    const resetBtn = document.getElementById('filter-reset');

    filterSelect.addEventListener('change', handleViltFilters);
    filterSearch.addEventListener('change', handleViltFilters);
    resetBtn.addEventListener('click', handleFilterReset);

    // resets view by displaying all possible VILT event cards
    function displayVilt() {
        const viltCards = document.querySelectorAll('.card-wide');
        for (card of viltCards) card.style.display = 'flex';
    }

    // handles all VILT filters on all cards
    function handleViltFilters(e) {
        displayVilt();  // reset view
        // pass cards through all filters
        const viltCards = document.querySelectorAll('.card-wide');
        handleViltSelect(viltCards);
        handleViltSearch(viltCards);
    }

    // filters and returns VILT cards by capability selection
    function handleViltSelect(viltCards) {
        const select = document.getElementById('filter-select').value.toLowerCase();

        // filter by capability stored on data-tag of each card
        for (card of viltCards) {
            const tag = card.dataset.tag.toLowerCase();
            if (tag != select && select != "all") {
                card.style.display = "none";
            }
        }
        return viltCards;
    }

    // filters and returns VILT cards by name search
    function handleViltSearch(viltCards) {
        const input = document.getElementById('filter-search').value.toLowerCase();

        // filter by name given in search input
        for (card of viltCards) {
            const name = card.lastElementChild.firstElementChild.innerText;
            if (!name.toLowerCase().includes(input)) {
                card.style.display = "none";
            }
        }
        return viltCards
    }

    // displays all VILT cards and resets filter controls
    function handleFilterReset() {
        displayVilt();

        const filterSelect = document.getElementById('filter-select');
        const filterSearch = document.getElementById('filter-search');
        filterSelect.value = 'all';
        filterSearch.value = '';
    }

</script>